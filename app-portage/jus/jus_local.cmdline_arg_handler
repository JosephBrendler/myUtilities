#!/bin/sh
# this is a local jus-specific commandline argument module derived
#  from joetoo_cli_example_local.cmdline_arg_handler
# (to extend script_header_joetoo's process_cmdline capability)
#
# ** will be sourced by using script to make these three functions available
# Convention for cmdline arg handling:
#   set result=0 for success with no operand
#   set result=6 for success with operand
#   set result=7 for file not found (to differentiate from error)
#   set result = 1  for error

handle_local_arg() # (POSIX) local compound arg handler to extend cli in script_header_joetoo
{ hla_ret=0; _hla_arg="$1"; _hla_operand="$2"
  debug_msg "in handle_local_arg with _hla_arg: [$_hla_arg], _hla_operand: [$_hla_operand]"
  case "$_hla_arg" in
    "-a" | "--glsa"          )
      info_msg "${BYon}seting GLSA_CHECK=yes${Boff}"
      GLSA_CHECK="yes" || hla_ret=1 ;;
    "-c" | "--check"         )
      info_msg "${BYon}seting UPDATE_CHECK=yes${Boff}"
      UPDATE_CHECK="yes" || hla_ret=1 ;;
    "-d" | "--distcc"        )
      info_msg "${BYon}seting DISTCC=yes${Boff}"
      DISTCC="yes" || hla_ret=1 ;;
    "-e" | "--eix"           )
      info_msg "${BYon}seting EIX_UPDATE=yes${Boff}"
      EIX_UPDATE="yes" || hla_ret=1 ;;
    "-g" | "--getbinpkg"     )
      info_msg "${BYon}seting GETBINPKG=yes${Boff}"
      GETBINPKG="yes" || hla_ret=1 ;;
    "-G" | "--getbinpkgonly" )
      info_msg "${BYon}seting GETBINPKGONLY=yes${Boff}"
      GETBINPKGONLY="yes" || hla_ret=1 ;;
    "-k" | "--usepkg"        )
      info_msg "${BYon}seting USEPKG=yes${Boff}"
      USEPKG="yes" || hla_ret=1 ;;
    "-K" | "--usepkgonly"    )
      info_msg "${BYon}seting USEPKGONLY=yes${Boff}"
      USEPKGONLY="yes" || hla_ret=1 ;;
    "-m" | "--modules"       )
      info_msg "${BYon}seting MODULE_REBUILD=yes${Boff}"
      MODULE_REBUILD="yes" || hla_ret=1 ;;
    "-M" | "--emaint"        )
      info_msg "${BYon}seting EMAINT_CHECK=yes${Boff}"
      EMAINT_CHECK="yes" || hla_ret=1 ;;
    "-n" | "--nodist"        )
      info_msg "${BYon}seting DISTCC=no${Boff}"
      DISTCC="no" || hla_ret=1 ;;
    "-p" | "--perl_cleaner"  )
      info_msg "${BYon}seting PERL_CLEANER=yes${Boff}"
      PERL_CLEANER="yes" || hla_ret=1 ;;
    "-P" | "--python"        )
      info_msg "${BYon}seting PYTHON_UPDATER=yes${Boff}"
      PYTHON_UPDATER="yes" || hla_ret=1 ;;
    "-R" | "--regen"         )
      info_msg "${BYon}seting REGEN_OVERLAY_METADATA=yes${Boff}"
      REGEN_OVERLAY_METADATA="yes" || hla_ret=1 ;;
    "-S" | "--selinux"       )
      info_msg "${BYon}seting SELINUX_RELABEL=yes${Boff}"
      SELINUX_RELABEL="yes" || hla_ret=1 ;;
    "-t" | "--rkhunter"      )
      info_msg "${BYon}seting RKHUNTER=yes${Boff}"
      RKHUNTER="yes" || hla_ret=1 ;;
    "-U" | "--changeduse"    )
      info_msg "${BYon}seting CHANGEDUSE=yes${Boff}"
      CHANGEDUSE="yes" || hla_ret=1 ;;
    "-w" | "--with-bdeps=y"  )
      info_msg "${BYon}seting WITH_BDEPS_Y=yes${Boff}"
      WITH_BDEPS_Y="yes" || hla_ret=1 ;;
    "-W" | "--newuse"        )
      info_msg "${BYon}seting NEWUSE=yes${Boff}"
      NEWUSE="yes" || hla_ret=1 ;;
    "-x" | "--exclude"       )
      info_msg "${BYon}seting EXCLUDE=$2${Boff}"
      EXCLUDE="${2}" && hla_ret=6 || hla_ret=1 ;;
    "-X" | "--X11"           )
      info_msg "${BYon}seting X11_MODULE_REBUILD=yes${Boff}"
      X11_MODULE_REBUILD="yes" || hla_ret=1 ;;
    "-y" | "--sync"          )
      info_msg "${BYon}seting SYNC=yes${Boff}"
      SYNC="yes" || hla_ret=1 ;;
    "-Y" | "--go-ahead"      )
      info_msg "${BYon}seting INTERACTIVE=\$FALSE"
      INTERACTIVE="$FALSE" || hla_ret=1 ;;
    "-Z" | "--keep-going"    )
      info_msg "${BYon}seting KEEPGOING=yes${Boff}"
      KEEPGOING="yes" || hla_ret=1 ;;
    "-H" | "--haskell"       )
      info_msg "${BYon}seting HASKELL_UPDATER=yes${Boff}"
      HASKELL_UPDATER="yes" || hla_ret=1 ;;
    "-u" | "--update-all"    )
      info_msg "${BYon}seting --update-all${Boff}"
      GLSA_CHECK="yes" && EIX_UPDATE="yes" && MODULE_REBUILD="yes" && \
                               EMAINT_CHECK="yes" && PERL_CLEANER="yes" && \
                               PYTHON_UPDATER="yes" && REGEN_OVERLAY_METADATA="yes" && \
                               SELINUX_RELABEL="yes" && RKHUNTER="yes" && WITH_BDEPS_Y="yes" && \
                               X11_MODULE_REBUILD="yes" && SYNC="yes" && HASKELL_UPDATER="yes" || hla_ret=1 ;;
    * )
      # NOTICE: getting here does not mean error - it just means no single flag option matched,
      # but $1 could still be a compound argument (cluster of single-letter flags), so we have
      # to differentiate that (not found) status from "error", and fall back to the main script's logic
      hla_ret=7 # not found
      ;;
  esac
  debug_msg "handle_local_arg complete, returning [$hla_ret]"
  unset -v _hla_arg _hla_operand
  return $hla_ret
}
# @usage handle_local_compound_arg (called from script_header_joetoo)
# @args $1=current arg, $2=potential operand
# @ret 0: successful action option for flag identified, 1: error
# @ret 6: consumed an operand, 7: file not found
# @note operates at INFO severity level
# @note examines string for match to known flags (e.g. -r|--resume)

handle_local_compound_arg() # (POSIX) local compound arg handler to extend cli in script_header_joetoo
{ hlca_ret=0; _hlca_char="${_pca_args%${_pca_args#?}}" # Get the first character of _pca_args
  debug_msg "in handle_local_compound_arg with _pca_args: [$_pca_args], _hlca_char: [$_hlca_char]"
  case "$_hlca_char" in
    "a")
      info_msg "${BYon}seting GLSA_CHECK=yes${Boff}"
      GLSA_CHECK="yes" || hlca_ret=1 ;;
    "c")
      info_msg "${BYon}seting UPDATE_CHECK=yes${Boff}"
      UPDATE_CHECK="yes" || hlca_ret=1 ;;
    "d")
      info_msg "${BYon}seting DISTCC=yes${Boff}"
      DISTCC="yes" || hlca_ret=1 ;;
    "e")
      info_msg "${BYon}seting EIX_UPDATE=yes${Boff}"
      EIX_UPDATE="yes" || hlca_ret=1 ;;
    "g")
      info_msg "${BYon}seting GETBINPKG=yes${Boff}"
      GETBINPKG="yes" || hlca_ret=1 ;;
    "G")
      info_msg "${BYon}seting GETBINPKGONLY=yes${Boff}"
      GETBINPKGONLY="yes" || hlca_ret=1 ;;
    "k")
      info_msg "${BYon}seting USEPKG=yes${Boff}"
      USEPKG="yes" || hlca_ret=1 ;;
    "K")
      info_msg "${BYon}seting USEPKGONLY=yes${Boff}"
      USEPKGONLY="yes" || hlca_ret=1 ;;
    "m")
      info_msg "${BYon}seting MODULE_REBUILD=yes${Boff}"
      MODULE_REBUILD="yes" || hlca_ret=1 ;;
    "M")
      info_msg "${BYon}seting EMAINT_CHECK=yes${Boff}"
      EMAINT_CHECK="yes" || hlca_ret=1 ;;
    "n")
      info_msg "${BYon}seting DISTCC=no${Boff}"
      DISTCC="no" || hlca_ret=1 ;;
    "p")
      info_msg "${BYon}seting PERL_CLEANER=yes${Boff}"
      PERL_CLEANER="yes" || hlca_ret=1 ;;
    "P")
      info_msg "${BYon}seting PYTHON_UPDATER=yes${Boff}"
      PYTHON_UPDATER="yes" || hlca_ret=1 ;;
    "R")
      info_msg "${BYon}seting REGEN_OVERLAY_METADATA=yes${Boff}"
      REGEN_OVERLAY_METADATA="yes" || hlca_ret=1 ;;
    "S")
      info_msg "${BYon}seting SELINUX_RELABEL=yes${Boff}"
      SELINUX_RELABEL="yes" || hlca_ret=1 ;;
    "t")
      info_msg "${BYon}seting RKHUNTER=yes${Boff}"
      RKHUNTER="yes" || hlca_ret=1 ;;
    "U")
      info_msg "${BYon}seting CHANGEDUSE=yes${Boff}"
      CHANGEDUSE="yes" || hlca_ret=1 ;;
    "w")
      info_msg "${BYon}seting WITH_BDEPS_Y=yes${Boff}"
      WITH_BDEPS_Y="yes" || hlca_ret=1 ;;
    "W")
      info_msg "${BYon}seting NEWUSE=yes${Boff}"
      NEWUSE="yes" || hlca_ret=1 ;;
    "X")
      info_msg "${BYon}seting X11_MODULE_REBUILD=yes${Boff}"
      X11_MODULE_REBUILD="yes" || hlca_ret=1 ;;
    "Y")
      info_msg "${BYon}seting GO_AHEAD=yes${Boff}"
      GO_AHEAD="yes" || hlca_ret=1 ;;
    "y")
      info_msg "${BYon}seting SYNC=yes${Boff}"
      SYNC="yes" || hlca_ret=1 ;;
    "Z")
      info_msg "${BYon}seting KEEPGOING=yes${Boff}"
      KEEPGOING="yes" || hlca_ret=1 ;;
    "H")
      info_msg "${BYon}seting HASKELL_UPDATER=yes${Boff}"
      HASKELL_UPDATER="yes" || hlca_ret=1 ;;
    "u")
      info_msg "${BYon}seting --update-all${Boff}"
      CHANGEDUSE="yes" && NEWUSE="yes" && \
         GLSA_CHECK="yes" && EIX_UPDATE="yes" && MODULE_REBUILD="yes" && \
         EMAINT_CHECK="yes" && PERL_CLEANER="yes" && \
         PYTHON_UPDATER="yes" && REGEN_OVERLAY_METADATA="yes" && \
         SELINUX_RELABEL="yes" && RKHUNTER="yes" && WITH_BDEPS_Y="yes" \
         X11_MODULE_REBUILD="yes" && SYNC="yes" && HASKELL_UPDATER="yes" || hlca_ret=1 ;;
    *   )
      # NOTICE: getting here does not mean error - it just means no single flag option matched,
      # but $1 could still be a compound argument (cluster of single-letter flags), so we have
      # to differentiate that (not found) status from "error", and fall back to the main script's logic
      hlca_ret=7 # not found
      ;;
  esac
  debug_msg "handle_local_compound_arg complete, returning [$hlca_ret]"
  unset -v _hlca_char
  return $hlca_ret
}
# @usage handle_local_compound_arg (called from script_header_joetoo)
# @ret 0: successful action option for flag identified, 1: error, 7: file not found
# @rule this function expects the parent script to have already stripped the leading '-'
# @note operates at INFO severity level
# @note examines the *first character* of the remaining _pca_args string

handle_local_usage() # (POSIX) local usage module to extend cli in script_header_joetoo
{
   notice_msg "${BGon}Useage: jus [option]${Boff}"
   notice_msg " ${BWon}Command line options:${Boff}"
   notice_msg "   ${BYon}Options for Phase 1 - ${phase_message[0]}${Boff}"   ## phase 1 - Sync
   notice_msg "    ${BBon}[${Boff}${Con}-y | --sync${BBon}]${Boff} ............ force sync portage tree"
   notice_msg "    ${BBon}[${Boff}${Con}-R | --regen${BBon}]${Boff} ........... regenerate portage tree metadata (including overlays) "
   notice_msg "   ${BYon}Options for Phase 2 - ${phase_message[1]}${Boff}"   ## phase 2 - Update-Check
   notice_msg "    ${BBon}[${Boff}${Con}-c | --check${BBon}]${Boff} ........... check for and list updateable installed packages"
   notice_msg "   ${BYon}Options for Phase 3 - ${phase_message[2]}${Boff}"   ## phase 3 - Emerge Updates
   notice_msg "    ${BBon}[${Boff}${Con}-d | --distcc${BBon}]${Boff} .......... use distcc distributed compiling support"
   notice_msg "    ${BBon}[${Boff}${Con}-n | --nodist${BBon}]${Boff} .......... do not use distcc distributed compiling support"
   notice_msg "    ${BBon}[${Boff}${Con}-g | --getbinpkg${BBon}]${Boff} ....... use local and remote binary packages and ebuilds"
   notice_msg "    ${BBon}[${Boff}${Con}-G | --getbinpkgonly${BBon}]${Boff} ... use local and remote binary packages only"
   notice_msg "    ${BBon}[${Boff}${Con}-k | --usepkg${BBon}]${Boff} .......... use local binary packages and ebuilds"
   notice_msg "    ${BBon}[${Boff}${Con}-K | --usepkgonly${BBon}]${Boff} ...... use local binary packages only"
   notice_msg "    ${BBon}[${Boff}${Con}-U | --changeduse${BBon}]${Boff} ...... rebuild packages with changed USE flags"
   notice_msg "    ${BBon}[${Boff}${Con}-w | --WITH_BDEPS_Y${BBon}]${Boff} .... emerge with build-time dependencies"
   notice_msg "    ${BBon}[${Boff}${Con}-W | --newuse${BBon}]${Boff} .......... rebuild packages with added/changed USE"
   notice_msg "    ${BBon}[${Boff}${Con}-x | --exclude <atom>${BBon}]${Boff} .. exclude <atom> from emerge"
   notice_msg "    ${BBon}[${Boff}${Con}-Y | --go-ahead${BBon}]${Boff} ........ automatically continue to next phases"
   notice_msg "    ${BBon}[${Boff}${Con}-Z | --keep-going${BBon}]${Boff} ...... on emerge failure, try to keep emerging other packages"
   notice_msg "   ${BYon}Options for Phase 4 - ${phase_message[3]}${Boff}"   ## phase 4 - Review news and Maintain Config Files
   info_msg     " ${BCon}[future development${BBon}]${Boff}"
   notice_msg "   ${BYon}Options for Phase 5 - ${phase_message[4]}${Boff}"   ## phase 5 - Review elogs
   info_msg     " ${BCon}[future development${BBon}]${Boff}"
   notice_msg "   ${BYon}Options for Phase 6 - ${phase_message[5]}${Boff}"   ## phase 6 - Handle Dependencies
   info_msg     " ${BCon}[future development${BBon}]${Boff}"
   notice_msg "   ${BYon}Options for Phase 7 - ${phase_message[6]}${Boff}"   ## phase 7 - Final steps
   notice_msg "    ${BBon}[${Boff}${Con}-a | --glsa${BBon}]${Boff} ............ run glsa-check -vp affected"
   notice_msg "    ${BBon}[${Boff}${Con}-e | --eix${BBon}]${Boff} ............. run eix-update"
   notice_msg "    ${BBon}[${Boff}${Con}-m | --modules${BBon}]${Boff} ......... run emerge @module-rebuild"
   notice_msg "    ${BBon}[${Boff}${Con}-M | --emaint${BBon}]${Boff} .......... run emaint --check all"
   notice_msg "    ${BBon}[${Boff}${Con}-p | --perl_cleaner${BBon}]${Boff} .... run perl-cleaner --all"
   notice_msg "    ${BBon}[${Boff}${Con}-P | --python${BBon}]${Boff} .......... run python-updater"
   notice_msg "    ${BBon}[${Boff}${Con}-S | --selinux${BBon}]${Boff} ......... redo selinux lablels"
   notice_msg "    ${BBon}[${Boff}${Con}-t | --rkhunter${BBon}]${Boff} ........ run rkhunter --propupd"
   notice_msg "    ${BBon}[${Boff}${Con}-X | --X11${BBon}]${Boff} ............. run emerge @x11-module-rebuild"
   notice_msg "    ${BBon}[${Boff}${Con}-H | --haskell${BBon}]${Boff} ......... run haskell-updater"
   echo_msg ""
   notice_msg "  ${BYon}Notes: ${Boff}"
   notice_msg "  ${BYon} (1)${Boff} --sync is set automatically if portage tree is older"
   notice_msg "    than MAX_AGE (set in jus.conf)"
   notice_msg "  ${BYon} (2)${Boff} option(s) -[k|K|g|G] function as explained in gentoo binary package guide:"
   notice_msg "    https://wiki.gentoo.org/wiki/Binary_package_guide"
   notice_msg "  ${BYon} (3)${Boff} option(s) -[d|n] are mutually exclusive opposites"
   notice_msg "    if both used, DISTCC will be reset yes/no by the right-most cmdline"
   notice_msg "  ${BYon} (4)${Boff} option(s) -[W|U] are similar. Subsequent depclean may require NEWUSE, but"
   notice_msg "    CHANGEDUSE instead can avoid unnecessary rebuilds.  See these references for more info:"
   notice_msg "      https://forums.gentoo.org/viewtopic-p-8719502.html?sid=1e3d721ff79585b67bb9255a51c01f3f"
   notice_msg "      https://www.reddit.com/r/Gentoo/comments/16ua43e/changeduse_vs_newuse/"
   notice_msg "      https://wiki.gentoo.org/wiki/Gentoo_Cheat_Sheet"
   notice_msg "      https://wiki.gentoo.org/wiki/Emerge"
   notice_msg "      https://wiki.gentoo.org/wiki/Full_manpages/emerge"
}
# @usage handle_local_usage  (called from usage() in script_header_joetoo)
# @rule user-script specific usage-module which should be built in joetoo format
# @rule this file must contain legitimate bash assignments and commands
# @note operates at NOTICE severity level
# @note options h, i, n, s, r, v, q V, Q are already used by the joetoo cmdline processor

#!/bin/bash
# moved the bs() function to script_header_brendlefly

#----[ main script - alphabetize the list, then search it ]---------------
source /usr/local/sbin/script_header_brendlefly
unfriendlies="/etc/gus/distcc_unfriendly"
worldfile="/var/lib/portage/world"
nodistmergelist=()
candistmergelist=()
candistworldlist=()
nodistcount=0
candistcount=0
candistworldcount=0
if [[ ! -z $1 ]]
then
  if [[ $1 =~ [0-9] ]]
  then
     VERBOSE=$TRUE
     verbosity=$1
  else
    VERBOSE=$TRUE
    verbosity=1
  fi
else
  VERBOSE=$FALSE
  verbosity=0
fi

for package in $(eix -u#)
do
  let "depth=1"
  let "result=-1"
  range=($(cat $unfriendlies | sort -udb))
  limit=${#range[@]}
  d_message "${BYon}Looking for ${BWon}$package ${BYon}in ${BWon}$unfriendlies ${BYon}--${Boff}" 1
  d_message "  ${BYon}searching among ${BWon}${#range[@]} ${BYon}candidate entries...${Boff}" 1
  d_echo 2
  DIFF1UPPER=$FALSE
  DIFF1LOWER=$FALSE
  bs $package 0 ${#range[@]} ${range[@]}
  d_message "just got back from binary search, result is $result" 2
  if [[ ${result} -gt 0 ]]
  then
    d_message "${BGon}Found ${range[result]} at line ${BWon}${result}${BGon} of ${unfriendlies}${Boff}" 1
    nodistmergelist[${nodistcount}]="${package}"
    let "nodistcount+=1"
  else
    dE_message "${BRon}Not found${Boff}" 1
    candistmergelist[${candistcount}]="${package}"
    let "candistcount+=1"
  fi
  d_message "(had to go to depth $depth to figure that out)" 2
done

for package in ${candistmergelist[@]}
do
  let "depth=1"
  let "result=-1"
  range=($(cat $worldfile | sort -udb))
  limit=${#range[@]}
  d_message "${BYon}Looking for ${BWon}$package ${BYon}in ${BWon}$worldfile ${BYon}--${Boff}" 1
  d_message "  ${BYon}searching among ${BWon}${#range[@]} ${BYon}candidate entries...${Boff}" 1
  d_echo 2
  DIFF1UPPER=$FALSE
  DIFF1LOWER=$FALSE
  bs $package 0 ${#range[@]} ${range[@]}
  d_message "just got back from binary search, result is $result" 2
  if [[ ${result} -gt 0 ]]
  then
    d_message "${BGon}Found ${range[result]} at line ${BWon}${result}${BGon} of ${worldfile}${Boff}" 1
    candistworldlist[${candistworldcount}]="${package}"
    let "candistworldcount+=1"
  else
    dE_message "${BRon}Not found${Boff}" 1
  fi
  d_message "(had to go to depth $depth to figure that out)" 2
done

d_echo
message "${BWon}These are the $nodistcount updateable packages on the nodistmergelist:${BRon}"
for ((i=0; i<${#nodistmergelist[@]}; i++)); do echo -e "   ${nodistmergelist[i]}"; done
echo
message "${BWon}These are the $candistcount updateable packages on the candistmergelist:${BGon}"
for ((i=0; i<${#candistmergelist[@]}; i++)); do echo -e "   ${candistmergelist[i]}"; done
echo
message "${BWon}These are the $candistworldcount updateable packages in $worldfile and on the candistmergelist:${BGon}"
for ((i=0; i<${#candistworldlist[@]}; i++)); do echo -e "   ${candistworldlist[i]}"; done
echo -e ${Boff}

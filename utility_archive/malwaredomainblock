#!/bin/bash
# generate list of domain names and associated ip addresses to block
# source: malwaredomains.lehigh.edu/files/domains.txt

source /usr/local/sbin/script_header_brendlefly
BUILD="0.0.01 (20141116)"
sourcefile_URL="http://malwaredomains.lehigh.edu/files/domains.txt"
domaintoipfile="domaintoipfile.txt"
malwareblocklistfile="malwaredomainblocklist.txt"

#---[ main script ]--------------------
separator "malwaredomainblock-${BUILD}"
checkroot

[ -e domains.txt ] && rm domains.txt
echo -en "${BGon} * ${Boff}Downloading domains.txt from ${sourcefile_URL}...  "
wget ${sourcefile_URL} 2>/dev/null && echo -e "[ ${BGon}Ok${Boff} ]" || echo -e "[ ${BRon}Fail${Boff} ]"


echo "# Joe Brendler - Malware Blocklist File as of $(date)" > ${malwareblocklistfile}

for i in $(grep -v "#" domains.txt | cut -f3)
do
  echo -en "${BGon} * ${Boff}Looking up $i\t\t"
  this_ip="$( nslookup $i | grep -v '192.168.61.17' | grep 'Address' | cut -d' ' -f2)" && \
    echo ${this_ip} || echo "error resolving [ $i ] to [ ${this_ip} ]"
#  echo ${this_ip} > ${domaintoipfile}

  echo -en "${BGon} * ${Boff}Getting whois CIDR info on ${this_ip}...   "
  wget https://isc.sans.edu/ipinfo.html?ip=${this_ip} 2>/dev/null && \
    echo -e "[ ${BGon}Ok${Boff} ]" || echo -e "[ ${BRon}Fail${Boff} ]"
  grep "CIDR" "ipinfo.html?ip=${this_ip}" | cut -b17- | sed 's/,//' >> ${malwareblocklistfile}
  rm "ipinfo.html?ip=${this_ip}"
done

[ -e "${domaintoipfile}" ] && rm -i ${domaintoipfile} || message "no ${domaintoipfile} to delete."
[ -e domains.txt ] && rm domains.txt


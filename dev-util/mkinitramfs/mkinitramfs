#!/bin/bash
# Joe Brendler - 11 November 2016
# Wrapper script to automate my initramfs build procedure
# The GLOBALS file identifies the SOURCES_DIR (e.g. /usr/src/initramfs),
# the SCRIPT_HEADER_DIR, and the MAKE_DIR (parent dir of this script).
# Note: you must run these scripts from the directory in which they
# reside (the ${MAKE_DIR}).  As of 5.3, the BUILD variable is generated
# analytically at sources-build-time, and stored in the a file found at
# ${SOURCES_DIR}/BUILD.  This is now independent of GLOBALS, and the
# script_header-sourced BUILD variable is ignored.  make_sources.sh also
# uses the BUILD value in its visual separators while providing progress
# output for the user.  This script will not have access to the BUILD
# value until after make_sources is run; here it is used only in the
# final visual output
# NOTE: if in testing mode, substitute three lines below

#-----[ initialize variables ]-------------------------------------------------
echo -n "Sourcing globals... "
source GLOBALS
# subsititure below for testing only
#source GLOBALS.scratch_test

if [[ $? -eq 0 ]]; then echo "ok"; else echo "Error: failed to source GLOBALS"; exit 1; fi

img_ROOT="/"; suffix=""; prefix=""
# subsititure below for testing only
#img_ROOT="${MAKE_DIR%/}/scratch/"; suffix=".test"; prefix="scratch/"

source "${SCRIPT_HEADER_DIR}/script_header_joetoo"

old_dir=$(pwd)

# set defaults (ROTATE, like globally defined TRUE=0; FALSE="" is a pseudo-boolean;
#   only ever assigned ROTATE=$TRUE or =$FALSE, [ $ROTATE ] will always evaluate as expected
ROTATE=$FALSE

# load customized configuration parameters - subsequent assignments supercede defaults
[[ -e "${MAKE_DIR}/mkinitramfs.conf" ]] && config_file="${MAKE_DIR}/mkinitramfs.conf"
[[ -e /etc/mkinitramfs/mkinitramfs.conf ]] && config_file="/etc/mkinitramfs/mkinitramfs.conf"
source "${config_file}"

# backup old initramfs sources directory if it exists
if [[ -d "${SOURCES_DIR}" ]]; then
  # keep more than one old version if necessary (use array of directory names rather than ls)
  #  pre_existing=$(set $(find $(dirname "$SOURCES_DIR") -maxdepth 1 -mindepth 1 -type d -iname 'initramfs*' -print); echo $#)
  # readarray with find ... -print0 is the safer way to do this
  readarray -d '' bak_dirs < <(find $(dirname "$SOURCES_DIR") -maxdepth 1 -mindepth 1 -type d -iname 'initramfs*' -print0)
  pre_existing=${#bak_dirs[@]}
  message_n "backing up pre-existing initramfs directory"
  mv "${SOURCES_DIR}" "${SOURCES_DIR}.bak.${pre_existing}"
  handle_result $? "initramfs.bak.${pre_existing}" "failed" || \
    E_message "failed to mv ${SOURCES_DIR} ${SOURCES_DIR}.bak.${pre_existing}"
fi

#-----[ main script ]----------------------------------------------------------

# (re-)create and (re-)load the ${SOURCES_DIR}
"${MAKE_DIR}/${prefix}make_sources.sh${suffix}"

# unless testing, mount the boot device if it wasn't already
if ! -z "$suffix"; then
  message_n "checking if /boot is mounted"
  checkboot >/dev/null
  result=$?
  handle_result $result "mounted" "not mounted"
  if [ ! $result -eq 0 ]; then
    message_n "Mounting /boot..."
    mount -o rw /boot
    handle_result $? || die "failed to mount -o rw /boot"
  fi  # checkboot result
fi  # testing?

# generate and install the acutal image (cpio.gz archive of the sources)
"${MAKE_DIR}/${prefix}make_image.sh${suffix}"

# (Optionally) auto-rotate initramfs images, if called for in .conf

[[ $ROTATE ]] && "${MAKE_DIR}/${prefix}rotate_initramfs.sh${suffix}"

# get the BUILD number generated by make_sources.sh
source "${SOURCES_DIR}/BUILD"

# show the results
separator "Please verify the results, below)" "initramfs-${BUILD} installed"
# list files in /boot/ with names containing "initramfs"
find "${img_ROOT%/}/boot/" -maxdepth 1 -type f -iname 'initramfs*' -print
separator "${PN}-${BUILD}" "(Done)"
echo

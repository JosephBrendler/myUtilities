#!/bin/bash
# Joe Brendler  29 Dec 2012
#   for version history and "credits", see the accompanying "historical_notes" file
#   as ov version 5.2, this script is provided separately, in case the user does
#   NOT want to use it, but rather prefers to only make the sources and have the
#   initramfs compiled into the kernel

# this script must be run from the directory in which these scripts reside (so that
#   "source GLOBALS" makes sense.  GLOBALS instantiates all the variables needed
#   for directory-references.  This script must also be run AFTER the make_sources.sh
#   script is run, because the latter generates the BUILD file in ${SOURCES_DIR} that
#   will be sourced here to instantiate the BUILD variable
#source GLOBALS
# subsititure below for testing only
source GLOBALS.scratch_test

# source my usual functions and formatting "shortcuts" (must be run from the MAKE_DIR)
source "${SCRIPT_HEADER_DIR}/script_header_joetoo"
source "${SOURCES_DIR}/BUILD"

# set verbosity if it was not set externally
[ -z "$verbosity" ] && verbosity=1

d_message "make_image.sh Debug - dump config" 4
d_message "BUILD: [ ${BUILD} ]" 4
d_message "MAKE_DIR: [ ${MAKE_DIR} ]" 4
d_message "SOURCES_DIR: [ ${SOURCES_DIR} ]" 4

#img_ROOT="/"
# subsititure below for testing only
img_ROOT="${MAKE_DIR%/}/scratch/"

make_initramfs()
{ # @usage make_initramfs
  # @note packs SOURCES_DIR into a compressed CPIO archive in /boot

  # if target file already exists, archive it to *.old
  [ -f "${img_ROOT%/}/boot/initramfs-${BUILD}" ] && cp -v "${img_ROOT%/}/boot/initramfs-${BUILD}" "${img_ROOT%/}/boot/initramfs-${BUILD}.old"

  find . -print0 | cpio --null -ov --format=newc | gzip -9 > "${img_ROOT%/}/boot/initramfs-${BUILD}"
}

#---[ main script ]----------
separator "Make initramfs Image"  "makeinitramfs-$BUILD"

# must be run by root with boot mounted already
# go to sources dir, and run function above to create initramfs image file
checkroot; checkboot;
old_pwd="$PWD"
if [ -d "${SOURCES_DIR}" ]; then
    message_n "moving to SOURCES_DIR: [${SOURCES_DIR}]"
    cd "${SOURCES_DIR}"
    handle_result $? || die "failed to cd ${SOURCES_DIR}"
    make_initramfs
else
    die "SOURCES_DIR [${SOURCES_DIR}] does not exist"
fi
cd "${old_pwd}"
d_message "all done" 1

#!/bin/sh

source /usr/sbin/script_header_joetoo

message_n "un-mounting keying device /mnt/thumb"
umount /mnt/thumb >/dev/null 2>&1
handle_result $?

message "recursively un-mounting newroot"
# there is no recursive umount in busybox/ash, so use this workaround
newroot_mp="/home/joe/myUtilities/dev-util/mkinitramfs/scratch/initramfs/newroot"
grep "${newroot_mp}" /proc/mounts | cut -d' ' -f2 | sort -r | while read -r mnt; do
    message_n "Unmounting: $(basename $mnt)"
    umount "$mnt" >/dev/null 2>&1
    handle_result $?
done
sleep .1

message_n "deactivating volume group vg_rock5bplus6401"
vgchange -an vg_rock5bplus6401 >/dev/null 2>&1
handle_result $?
sleep .1

message_n "closing luks encrypted container edb2"
cryptsetup luksClose edb2 >/dev/null 2>&1
handle_result $?



#!/bin/bash
source /usr/sbin/script_header_joetoo
checkroot

#-----[ variables ]------------------------------------------

PN=$(basename $0)
nextcloud_dir="/var/www/localhost/htdocs/myCloud"
silent=">/dev/null 2>&1"

VERBOSE=$TRUE
# don't set verbosity unless it is not already set (allow calling program to set it)
[ -z $verbosity ] && verbosity=3

separator $(hostname) ${PN}

command_sequence=(
    "sudo -u apache php occ maintenance:mode --on ${silent}"
    "sudo -u apache php occ maintenance:repair ${silent}"
    "sudo -u apache php occ maintenance:mode --off ${silent}"
)

msg_sequence=(
    'turn on maintenance mode'
    'conduct maintenance:repair'
    'turn off maintenance mode'
)

#-----[ main script ]------------------------------------------

old_dir=$(pwd)
message_n "${BYon}Moving to ${BMon}${nextcloud_dir}${Boff}"
cd ${nextcloud_dir} || die "failed to move to ${nextcloud_dir}"
right_status $TRUE
d_message "${BWon}pwd: ${LBon}$(pwd)${Boff}" 3

for ((i=0; i< ${#command_sequence[@]}; i++)) ; do
    message_n "${BWon}running ${BGon}${msg_sequence[$i]}${Boff} ..."
    eval "${command_sequence[$i]}" || die "failed: ${command_sequence[$i]}"
    right_status $TRUE
done
echo
message_n "${BYon}Moving back to ${BMon}${old_dir}${Boff}"
cd ${nextcloud_dir} || die "failed to move to ${nextcloud_dir}"
right_status $TRUE
d_message "${BWon}pwd: ${LBon}$(pwd)${Boff}" 3
message "${BGon}Done${Boff}"

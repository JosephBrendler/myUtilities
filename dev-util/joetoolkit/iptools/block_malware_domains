#!/bin/bash

source /usr/sbin/script_header_joetoo
checkroot
separator "block_malware_domains"

malware_block_ipset="block_malware"
temp_ipset="${malware_block_ipset}_temp"
ipset_params="hash:net"

#create the temporary ipset
message "creating ${temp_ipset}" && ipset create ${temp_ipset} ${ipset_params}
right_status $?

# process the entries in the malware domain listing generated by script ...
while read entry
do
  # if not a comment, consider adding to blocks
  if [ ! "${entry:0:1}" == "#" ]
  then
    # if not already in the ipset, add it
    ipset test ${temp_ipset} ${entry} 2>/dev/null
    if [ $? -ne 0 ]   # zero return means it IS already there
    then
      message "adding $entry"
      ipset add ${temp_ipset} ${entry} 2>/dev/null
      right_status $?
    else
      echo "$entry is already in ipset, skipping"
    fi
  else
    echo "------------------[ skipping comment ]-----------------"
  fi
done < /var/log/malwaredomainblocklist.txt
message "done building ipset"
# if ipset does not exist, create it
ipset create ${malware_block_ipset} ${ipset_params} 2>/dev/null

# swap the temp ipset for the live one
message "swapping ${temp_ipset} with ${malware_block_ipset}" && ipset swap ${temp_ipset} ${malware_block_ipset}
message "destroying ${temp_ipset}" && ipset destroy ${temp_ipset}
message "all done"


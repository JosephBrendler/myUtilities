#!/bin/bash
source /usr/sbin/script_header_joetoo
source /usr/sbin/script_header_joetoo_extended
source /usr/sbin/cb-common-functions
PN=$(basename $0)
user=joe
collection_directory="/home/${user}/collect-layout-data"
build_host="gmki91:/home/${user}/"

#-----[ functions ]-----------------------------------------------------------------------

list_used_disks() {
    # set this now because doing so will be an inappropriate use of io control for stdin during whi>
    TERMWIDTH=$(termwidth)
    # read every line of lsblk (NAME, TYPE, MOUNTPOINT columns)
    while read line ; do
        # use eval to interpret the -P pairs as variable assignments
        eval ${line}
        if [[ "${TYPE}" == "disk" ]] ; then
            # look for disks with no children (TYPE crypt, part, lvm) mounted
            candidate_name=$NAME ; candidate_type=$TYPE
            INUSE=$FALSE
            message_n "checking ${candidate_type} ${candidate_name} ..."
            while read innerline; do
                eval ${innerline}
                if [[ ! -z ${MOUNTPOINTS} ]] || [[ ! -z "$(findmnt | grep ${NAME})" ]] ; then
                    INUSE=$TRUE
                fi
            done <<<$(lsblk -P -o NAME,TYPE,MOUNTPOINTS /dev/${candidate_name})
            if [[ ! $INUSE ]] ; then
                echo -en "${BRon}(not in use) ${BWon}/dev/${candidate_name}${Boff}"
                non-stty-right_status 1
            else
                echo -en "${BGon}(in use) ${BMon}/dev/${candidate_name}${Boff}"
                non-stty-right_status 0
                lsblk /dev/${candidate_name} | sed 's|^|    |'
            fi
        fi
    done <<<$(lsblk -P -o NAME,TYPE,MOUNTPOINTS)
    return 0
}

usage() {
    E_message "usage: ${PN} <BOARD> <DEVICE>"
    echo
    message "${BYon}  BOARD: one of these --${Boff}"
    joetoo-sbc-list | sed 's|^|    |'
    echo
    message "${BYon}  DEVICE: e.g. /dev/mmcblk0 or /dev/nvme0n1 or /dev/sda${Boff}"
    message "  ${BMon}Here are candidates --${Boff}"
    list_used_disks
    echo
}


validate_source_device() {
    # SOURCE_DEVICE = physical block device to which crossbuilt image will be copied/flashed/deployed
    [ $# -ne 1 ] && E_message "Error: must specify source DEVICE" && return 1
    SOURCE_DEVICE=$1
    message_n "validating existence of source DEVICE: [ ${SOURCE_DEVICE} ] ..."
    if [ -b ${SOURCE_DEVICE} ] ; then
        right_status $TRUE
        message "running fdisk -l ${SOURCE_DEVICE} ..."
        fdisk -l ${SOURCE_DEVICE} | sed 's|^|    |'
    else
        right_status 1
        E_message "no such block device found for [ ${SOURCE_DEVICE} ]"
        exit 1
    fi
    message_n "validating in-use status of source DEVICE ..."
    if [[ $(lsblk -l ${SOURCE_DEVICE} 2>/dev/null) ]] ; then
        right_status $TRUE
        message "running lsblk -l  ${SOURCE_DEVICE} ..."
        lsblk -l ${SOURCE_DEVICE}  | sed 's|^|    |'
    else
        right_status 1
        E_message "block device is not in use (no mountpoints)"
        exit 1
    fi
    return 0
}

#-----[ main script ]-----------------------------------------------------------------------
checkroot
separator $(hostname) ${PN}
[ $# -ne 2 ] && usage
BOARD="$1"
DEVICE="$2"

message_n "validating BOARD [${BOARD}]..."
validate_target ${BOARD} || die "failed to validate_target [${BOARD}]"
right_status $?

message "validating DEVICE [${DEVICE}] ..."
validate_source_device ${DEVICE} || die "failed to validate device [ ${DEVICE} ]"
right_status $?

medium=${DEVICE:5:3}
case $medium in
    "sd"[a-zA-Z] ) DEVTYPE="usb" ;;
    "mmc"        ) DEVTYPE="mmc" ;;
    "nvm"        ) DEVTYPE="nvme" ;;
    *            ) die "invalid medium [$medium]" ;;
esac

message_n "validating collection_directory ..."
if [ -d ${collection_directory} ] ; then
     echo -en " (${BGon}exists${Boff})"
else
     echo -en " (${BRon}not found${Boff})"
     mkdir -p ${collection_directory} || die "failed to mkdir -p ${collection_directory}"
     echo -en " (${BGon}created${Boff})"
fi
right_status $?

answer=""
prompt "is this a luks layout?"
expr "${answer:0:1}" : [yY] > /dev/null && ENC="luks" || ENC="plain"

message "about to collect sfdisk, blkid, and lsblk data"
confirm_continue_or_exit

message_n "collecting sfdisk data ..."
sfdisk -d ${DEVICE} > ${collection_directory%/}/sfdisk.${BOARD}.${DEVTYPE}.${ENC} || die "failed to collect sfdisk data"
right_status $?

message_n "collecting blkid data ..."
blkid | grep $(echo ${DEVICE} | sed 's|^/dev/||') > ${collection_directory%/}/blkid.${BOARD}.${DEVTYPE}.${ENC} || die "failed to collect blkid data"
right_status $?

message_n "collecting lsblk data ..."
lsblk -l -o NAME,SIZE,TYPE,MOUNTPOINTS ${DEVICE} > ${collection_directory%/}/lsblk.${BOARD}.${DEVTYPE}.${ENC} || die "failed to collect lsblk data"
right_status $?

message_n "changing ownership of collected files ..."
chown -R ${user}:${user} ${collection_directory%/} || die "failed to change ownership"
right_status $?


message "about to transfer data to build host [${build_host}]"
sudo -u ${user} scp ${collection_directory%/}/*.${BOARD}.${DEVTYPE}.${ENC} "${build_host}" || die "failed to transfer data to build host [${build_host}]"
message "${BGon}Done${Boff}"

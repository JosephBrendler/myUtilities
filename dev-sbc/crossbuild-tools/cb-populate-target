#!/bin/bash
#
# populate-target   (c) joe.brendler  2025-2072
# copy appropriate template files into crossbuild target filesystem
#

source /usr/local/sbin/script_header_brendlefly
VERBOSE=$TRUE
#verbosity=2
verbosity=3

PN=$(basename $0)

SOURCE_DIR=/etc/crossbuild-tools/mkenv-files
IMAGE_CONFIG_FILE=/root/.cb-config    # relative to /usr/${TARGET}

message_n "sourcing BUILD ..."
source /etc/crossbuild-tools/BUILD ; right_status $?

message_n "sourcing cb-common-functions ..."
source /usr/bin/cb-common-functions ; right_status $?
TARGET=""

usage() {
    message "${BRon}usage: ${BGon}${PN} <BOARD>${Boff}"
    usage-common-message
    exit
}

install_files_from_source() {
    SOURCE="$1"
    # strip source directory name from each pathname to use relative to /usr/${TARGET}/
    for x in $(find ${SOURCE} -type f | sed "s|${SOURCE}||") ; do
        DESTINATION="/usr/${TARGET}/$(dirname ${x})"
        FILE="$(basename ${x})"
        if [ ! -d ${DESTINATION} ] ; then
            d_echo "" 3
            d_message "TARGET......: ${TARGET}" 3
            d_message "SOURCE......: ${SOURCE}" 3
            d_message "x...........: ${x}" 4
            d_message "dirname x...: $(dirname $x)" 4
            d_message "basename x..: $(basename $x)" 4
            d_message "DESTINATION.: ${DESTINATION}" 3
            d_message "FILE........: ${FILE}" 3
            d_echo "" 3
            message_n "creating destination directory ${DESTINATION} ..."
            mkdir -p ${DESTINATION} && right_status $? || ( right_status $? && exit 1 )
        fi
        message_n "populating ${x} ..."
        cp ${SOURCE}${x} ${DESTINATION}/${FILE} && right_status $? || ( right_status $? && exit 1 )
    done
    return 0
}

save_config() {
    FLAGGED=$FALSE
    # first write creates/overwrites file; others append
    message_n "saving BOARD to /usr/${TARGET}${IMAGE_CONFIG_FILE} ..."
    echo "export BOARD=${BOARD}" > /usr/${TARGET}${IMAGE_CONFIG_FILE} && \
        right_status $? || ( right_status $? && FLAGGED=$TRUE )
    message_n "saving TARGET to /usr/${TARGET}${IMAGE_CONFIG_FILE} ..."
    echo "export TARGET=${TARGET}" >> /usr/${TARGET}${IMAGE_CONFIG_FILE}  && \
        right_status $? || ( right_status $? && FLAGGED=$TRUE )
    message_n "saving TARGET_ARCH to /usr/${TARGET}${IMAGE_CONFIG_FILE} ..."
    echo "export TARGET_ARCH=${TARGET_ARCH}" >> /usr/${TARGET}${IMAGE_CONFIG_FILE} && \
        right_status $? || ( right_status $? && FLAGGED=$TRUE )
    message_n "saving QEMU_ARCH to /usr/${TARGET}${IMAGE_CONFIG_FILE} ..."
    echo "export QEMU_ARCH=${QEMU_ARCH}" >> /usr/${TARGET}${IMAGE_CONFIG_FILE}
        right_status $? || ( right_status $? && FLAGGED=$TRUE )
    [ $FLAGGED ] && return 1 || return 0
}

#-----[ main script ]---------------------------------------------
checkroot
separator ${PN} $(hostname)
[ $# -ne 1 ] && usage
BOARD=$1
validate_target ${BOARD}

old_dir="$(pwd)"
cd /usr/${TARGET}
message "now working in target directory: [${Mon}$(pwd)${Boff}]"

#install_files_from_source "/etc/crossbuild-tools/files/${TARGET}/" || \
install_files_from_source "${SOURCE_DIR%/}/${BOARD}/" || \
    E_message "failed while installing files from ${SOURCE_DIR%/}/${BOARD}/"

#install_files_from_source "/etc/crossbuild-tools/files/common/" || \
install_files_from_source "${SOURCE_DIR%/}/common/" || \
    E_message "failed while installing files from ${SOURCE_DIR%/}/common/"

# make scripts executable in chroot (joetoo-meta should have deployed them with emerge-world)
DESTINATION="/usr/${TARGET}/usr/local/sbin"
message_n "setting permissions on scripts in ${DESTINATION} ..."
chmod +x ${DESTINATION}/script_header_brendlefly* && \
chmod +x ${DESTINATION}/finalize-chroot && \
chmod +x ${DESTINATION}/install_my_local_ca_certificates && \
right_status $? || ( right_status $? && exit 1 )

# save basic confguration data in /usr/${TARGET}${IMAGE_CONFIG_FILE}
save_config

echo
cd $old_dir
message "now working in previous directory: [${Mon}$(pwd)${Boff}]"
exit 0

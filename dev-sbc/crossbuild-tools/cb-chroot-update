#!/bin/bash
#
# chroot-update   (c) joe.brendler  2025-2072
#
# Note: derived from cb-chroot-target; but don't need to mount repos, sources for mature image
#
# ToDo: replicate chroot-prep commands in joetoo / directory
#   using mix of bind, rbind, types, --make-slave, and options
#   do this in cb-common-functions' mount-chroot-prep()/unmount-chroot-prep()

source /usr/sbin/script_header_joetoo
message_n "sourcing BUILD ..."
source /etc/crossbuild-tools/BUILD ; right_status $?
message_n "sourcing BPN ..."
source /etc/crossbuild-tools/BPN ; right_status $?
source /usr/sbin/script_header_joetoo_extended

VERBOSE=$TRUE
# set default verbosity only if it is not already set
[ -z $verbosity ] && verbosity=3

PN=$(basename $0)

message_n "sourcing cb-common-functions ..."
source /usr/sbin/cb-common-functions ; right_status $?

message_n "assigning user = joe (used to find/mount /home/<user>/xxx-sources)"
user="joe" && right_status $? || die "failed to assign user"

TARGET=""

usage() {
    message "${BRon}usage: ${BGon}${PN} <BOARD>${Boff}"
    smaller_script_common_usage_message
    echo
    exit
}

mount-everything() {
    separator "${PN}" "(${FUNCNAME[0]})"

    # copy resolv.conf
    message_n "copying /etc/resolv.conf for chroot target ..."
    cp /etc/resolv.conf /usr/${TARGET}/etc/resolv.conf >/dev/null 2>&1 && \
        right_status $? || die "failed to copy resolv.conf"

    # mount chroot-prep stuff
    mount_list="proc dev sys "
    mount-chroot-prep || die "failed mount-chroot-prep for ${PN}"
    #mount -o bind /tmp tmp
    #mount -o bind /dev/pts dev/pts #only for X
    return 0
}

umount-everything() {
    separator "${PN}" "(${FUNCNAME[0]})"
    #umount /usr/${TARGET}/dev/pts
    #umount /usr/${TARGET}/tmp
    FLAGGED=$FALSE
    # chroot-prep stuff
    mount_list="proc dev sys "
    umount-chroot-prep || FLAGGED=$TRUE

    [ $FLAGGED ] && return 1 || return 0
}

#-----[ main script ]---------------------------------------------
checkroot
separator ${PN} $(hostname)
[ $# -ne 1 ] && usage
BOARD=$1
validate_target ${BOARD} || die "Failed to validate_target [${BOARD}]"

message "restarting qemu-binfmt ..."
/etc/init.d/qemu-binfmt restart || die "failed to restart qemu-binfmt"

# Next two lines are optional.
# (Activate if the qemu-wrapper is used. Check that the wrapper location corresponds with the call at the end of line 2!)
#echo '-1' > /proc/sys/fs/binfmt_misc/arm #deregister wrong arm
#echo ':arm:M::\x7fELF\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x28\x00:\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\x00\xff\xfe\xff\xff\xff:/usr/local/bin/qemu-wrapper:' > /proc/sys/fs/binfmt_misc/register

old_dir="$(pwd)"
cd /usr/${TARGET}
message "now working in crossbuild target directory: [${Mon}$(pwd)${Boff}]"

mount-everything || die "failed to mount-everything"
 
chroot . /bin/bash --login
 
echo
cd $old_dir
message "now working in previous directory: [${Mon}$(pwd)${Boff}]"

umount-everything || die "failed to umount-everything and clean exit; note red flags above"

exit 0

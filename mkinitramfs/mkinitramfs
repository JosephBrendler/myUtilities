#!/bin/bash
# Joe Brendler - 11 November 2016
# Wrapper script to automate my initramfs build procedure
# The GLOBALS file identifies the SOURCES_DIR (e.g. /usr/src/initramfs),
# the SCRIPT_HEADER_DIR, and the MAKE_DIR (parent dir of this script).
# Note: you must run these scripts from the directory in which they
# reside (the ${MAKE_DIR}).  As of 5.3, the BUILD variable is generated
# analytically at sources-build-time, and stored in the a file found at
# ${SOURCES_DIR}/BUILD.  This is now independent of GLOBALS, and the
# script_header-sourced BUILD variable is ignored.  make_sources.sh also
# uses the BUILD value in its visual separators while providing progress
# output for the user.  This script will not have access to the BUILD
# value until after make_sources is run; here it is used only in the
# final visual output
source GLOBALS
source ${SCRIPT_HEADER_DIR}/script_header_brendlefly
old_dir=$(pwd)

# backup old initramfs sources directory
if [ -d ${SOURCES_DIR} ]
then
  # keep more than one old version if necessary (use array of directory names rather than ls)
  pre_existing=$(set $(find $(dirname $SOURCES_DIR) -maxdepth 1 -mindepth 1 -type d -iname 'initramfs*' -print); echo $#)
  mv ${SOURCES_DIR} ${SOURCES_DIR}.bak.$((${pre_existing} - 1))
fi

# (re-)create and (re-)load the ${SOURCES_DIR}
${MAKE_DIR}/make_sources.sh

# mount the boot device if it wasn't already
  ! checkboot >/dev/null && message "Mounting /boot..." && mount -o rw /boot
# generate and install the acutal image (cpio.gz archive of the sources)
${MAKE_DIR}/make_image.sh

# get the BUILD number generated by make_sources.sh
source ${SOURCES_DIR}/BUILD

# show the results
separator "Please verify the results, below)" "initramfs-${BUILD} installed"
# list files in /boot/ with names containing "initramfs"
find /boot/ -maxdepth 1 -type f -iname 'initramfs*' -print
separator "Done"  "mkinitramfs-${BUILD}"

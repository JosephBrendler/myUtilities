#!/bin/bash
# Joe Brendler - 11 November 2016
# Wrapper script to automate my initramfs build procedure
# The GLOBALS file identifies the SOURCES_DIR (e.g. /usr/src/initramfs),
# the SCRIPT_HEADER_DIR, and the MAKE_DIR (parent dir of this script).
# Note: you must first move to the directory containing these scripts
# (the ${MAKE_DIR}) to run these scripts
source GLOBALS
source ${SCRIPT_HEADER_DIR}/script_header_brendlefly

# backup old initramfs sources directory
if [ -d ${SOURCES_DIR} ]
then
  # keep more than one old version if necessary (use array of directory names rather than ls)
  pre_existing=($(find . * -maxdepth 0 -type d -print | grep initramfs))
  # start with 0, and don't count the mkinitramfs directory
  archive_num=$((${#pre_existing[@]} - 2))
  mv ${SOURCES_DIR} ${SOURCES_DIR}.bak.${archive_num}
fi

# (re-)create and (re-)load the ${SOURCES_DIR}
${MAKE_DIR}/make_sources.sh

# mount the boot device if it wasn't already
[ ! -e /boot/grub/grub.conf ] && mount -o rw /boot
# generate and install the acutal image (cpio.gz archive of the sources)
${MAKE_DIR}/make_image.sh

# GLOBALS identifies the KERNEL_VERSION and DATE_STAMP, which are used to
# generate the BUILD number, but BUILD is generated by the make_sources.sh script,
# So, the value of BUILD produced by sourcing GLOBALS in this script is not valid.
# Instead, use the value generated by make_sources.sh and stored in the new
# sources directory by sourcing ${SOURCES_DIR}/BUILD
source ${SOURCES_DIR}/BUILD

separator "Please verify the results, below" "initramfs-${BUILD} installed"
cd /boot/
ls -al /boot/ | grep initramfs                        # show the results
